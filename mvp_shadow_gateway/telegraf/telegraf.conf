# Telegraf config for MVP Shadow Gateway
[agent]
  interval = "500ms"
  round_interval = true
  flush_interval = "1s"
  metric_batch_size = 1000
  metric_buffer_limit = 10000

[global_tags]
  SITE = "${SITE}"
  LINHA = "${LINHA}"
  MAQUINA = "${MAQUINA}"

# --- INPUT: Modbus TCP (S7-1200 MB_SERVER) ---
[[inputs.modbus]]
  name = "modbus"
  controller = "tcp://${MB_HOST}:502"
  slave_id = ${MB_UNIT}
  timeout = "200ms"

  # Coils (digital signals)
  coils = [
    { name = "S1_piece", address = [1] },
    { name = "S2_scrap", address = [2] },
    { name = "RUN",      address = [3] }
  ]

  # Holding registers (analog/data words)
  holding_registers = [
  { name = "Current_x10",    byte_order = "AB",   data_type = "INT16",  scale = 1.0, address = [1]  },
  { name = "Vibration_x10",  byte_order = "AB",   data_type = "INT16",  scale = 1.0, address = [2]  },
  { name = "GoodCount_lo",   byte_order = "AB",   data_type = "UINT16", scale = 1.0, address = [10] },
  { name = "GoodCount_hi",   byte_order = "AB",   data_type = "UINT16", scale = 1.0, address = [11] },
  { name = "ScrapCount_lo",  byte_order = "AB",   data_type = "UINT16", scale = 1.0, address = [12] },
  { name = "ScrapCount_hi",  byte_order = "AB",   data_type = "UINT16", scale = 1.0, address = [13] }
  ]

# --- PROCESSORS: compute GoodCount/ScrapCount DINT and Quality ---
[[processors.starlark]]
  namepass = ["modbus"]
  script = "/etc/telegraf/processors/32bit_join.star"

[[processors.starlark]]
  namepass = ["modbus"]
  script = "/etc/telegraf/processors/quality.star"

# --- OUTPUT: InfluxDB v2 ---
[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "${INFLUX_TOKEN}"
  organization = "${INFLUX_ORG}"
  bucket = "${INFLUX_BUCKET}"

# --- OPTIONAL INPUT: MQTT consumer (enable if using MQTT) ---
# [[inputs.mqtt_consumer]]
#   servers = ["tcp://mosquitto:1883"]
#   topics = ["plc/+/metrics"]
#   username = "${MQTT_USERNAME}"
#   password = "${MQTT_PASSWORD}"
#   data_format = "json"
