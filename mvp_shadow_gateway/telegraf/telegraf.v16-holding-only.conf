# Telegraf config for MVP Shadow Gateway — TIA v16 (MB_SERVER com apenas Holding Registers)
[agent]
  interval = "500ms"
  round_interval = true
  flush_interval = "1s"
  metric_batch_size = 1000
  metric_buffer_limit = 10000

[global_tags]
  SITE = "${SITE}"
  LINHA = "${LINHA}"
  MAQUINA = "${MAQUINA}"

# INPUT: Modbus TCP — Holding-only mapping (S1/S2/RUN em WORDs 0/1)
[[inputs.modbus]]
  name = "modbus"
  controller = "tcp://${MB_HOST}:502"
  slave_id = ${MB_UNIT}
  timeout = "200ms"

  # Sem coils/input registers nesta variante

  # Holding registers
  holding_registers = [
    # Analógicos x10
    { name = "Current_x10",   byte_order = "AB", data_type = "INT16",  scale = 1.0, address = [1] },
    { name = "Vibration_x10", byte_order = "AB", data_type = "INT16",  scale = 1.0, address = [2] },

    # Digitais (0/1) mapeados em WORDs 40003..40005
    { name = "S1_piece",      byte_order = "AB", data_type = "UINT16", scale = 1.0, address = [3] },
    { name = "S2_scrap",      byte_order = "AB", data_type = "UINT16", scale = 1.0, address = [4] },
    { name = "RUN",           byte_order = "AB", data_type = "UINT16", scale = 1.0, address = [5] },

    # Contadores 32-bit em duas WORDs (lo/hi)
    { name = "GoodCount_lo",  byte_order = "AB", data_type = "UINT16", scale = 1.0, address = [10] },
    { name = "GoodCount_hi",  byte_order = "AB", data_type = "UINT16", scale = 1.0, address = [11] },
    { name = "ScrapCount_lo", byte_order = "AB", data_type = "UINT16", scale = 1.0, address = [12] },
    { name = "ScrapCount_hi", byte_order = "AB", data_type = "UINT16", scale = 1.0, address = [13] }
  ]

# PROCESSORS: join 32-bit e Quality
[[processors.starlark]]
  namepass = ["modbus"]
  script = "/etc/telegraf/processors/32bit_join.star"

[[processors.starlark]]
  namepass = ["modbus"]
  script = "/etc/telegraf/processors/quality.star"

# OUTPUT: InfluxDB v2
[[outputs.influxdb_v2]]
  urls = ["http://influxdb:8086"]
  token = "${INFLUX_TOKEN}"
  organization = "${INFLUX_ORG}"
  bucket = "${INFLUX_BUCKET}"
